<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>PLEXO - Labelling of medical imagery for research</title>

<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="font-awesome/css/font-awesome.css" rel="stylesheet">
<link href="css/plugins/ionRangeSlider/ion.rangeSlider.css" rel="stylesheet">
<link href="css/plugins/ionRangeSlider/ion.rangeSlider.skinFlat.css" rel="stylesheet">
<link href="css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">
<link href="css/plugins/simplecolorpicker/jquery.simplecolorpicker.css" rel="stylesheet">
<link href="css/animate.css" rel="stylesheet">
<link href="css/style.css" rel="stylesheet">
<link href="css/custom.css" rel="stylesheet">

<script src="js/plugins/hammer/hammer.min.js"></script>
<script src="js/code/plexo.js"></script>
<script language="javascript">

	var view, slice, BRUSH;

	var init_slice = 210;
	var end_slice = 215;
	var step_slice = 1;

	BRUSH = new plx.Brush(5, 0.5, 'round');

	plx.setGlobalBrush(BRUSH);

	function load_dataset_callback(dataset) {
		var percentage = (dataset.num_loaded / dataset.num_items) * 100;
		$('#dataset-progress-bar-id').css('width', percentage + '%').attr('aria-valuenow', percentage);
		if (percentage == 100) {
			$('#dataset-progressbar-container-id').fadeOut(1000,
					function () {

						index = view.showMiddleSlice();
                        //setViewDimensions();

						setup_slider(index);
					});
			view.interactor.connectView();
		}
	}
	;

	function setup_slider(idx) {
		$('#dataset-slider-id').ionRangeSlider({
			hasGrid: false,
			min: init_slice,
			max: end_slice,
			from: idx,
			onChange: function (data) {
				index = data['fromNumber'];
				view.showSliceByIndex(index);
				view.showCurrentAnnotationSlice();
			}
		});
	}
	;

	function setup_brush_sliders() {
		$('#brush-size-slider-id').ionRangeSlider({
			hasGrid: true,
			min: 1,
			max: 10,
			from: BRUSH.size,
			onChange: function (data) {
				BRUSH.size = data['fromNumber'];
				draw_brush_preview();
			}
		});


		$('#brush-opacity-slider-id').ionRangeSlider({
			hasGrid: true,
			min: 0.5,
			max: 1,
			step: 0.1,
			from: BRUSH.opacity,
			onChange: function (data) {
				BRUSH.setOpacity(data['fromNumber']);
				draw_brush_preview();
			}
		});


	}
	;


	function setup_brush_type_buttons() {
		$('#brush-shape-circle').click(function () {
			BRUSH.type = 'round';
			draw_brush_preview();
		});

		$('#brush-shape-square').click(function () {
			BRUSH.type = 'square';
			draw_brush_preview();
		})

	}
	;

	function draw_brush_preview() {

		var canvas = document.getElementById('brush-canvas-id');
		var ctx = canvas.getContext("2d");

		var centerX = canvas.width / 2;
		var centerY = canvas.height / 2;
		var radius = BRUSH.size;

		ctx.clearRect(0, 0, canvas.width, canvas.height);
		draw_checkboard_brush_canvas(6, 6);

		ctx.fillStyle = BRUSH.color;

		if (BRUSH.type == 'round') {
			ctx.beginPath();
			ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
			ctx.fill();
		}
		else {
			var x1, y1, p;
			p = radius;
			x1 = centerX - p;
			y1 = centerY - p;
			ctx.fillRect(x1, y1, p * 2, p * 2);
		}
	}
	;

	function draw_checkboard_brush_canvas(nRow, nCol) {
		var can = document.getElementById('brush-canvas-id');
		var ctx = can.getContext("2d");

		// set up a pattern, something really elaborate!
		var p = document.createElement('canvas');
		p.width = 2 * can.width / nRow;
		p.height = 2 * can.height / nCol;

		var pctx = p.getContext('2d');
		pctx.fillStyle = "rgb(200, 200, 200)";
		pctx.fillRect(0, 0, p.width / 2, p.height / 2);
		pctx.fillRect(p.width / 2, p.height / 2, p.width / 2, p.height / 2);


		var pattern = ctx.createPattern(p, "repeat");

		ctx.fillStyle = pattern;
		ctx.fillRect(0, 0, can.width, can.height);
	};

	function setup_zoom_button() {
		$('#btn-zoom-id').click(function () {
			view.toggleFullscreen();
			view.showCurrentSlice();
			view.showCurrentAnnotationSlice();
		});
	};


	function setup_undo_button() {
		$('#btn-undo-id').click(function () {
			view.undo();
		});
	};

	function setup_brush_color_picker() {
		$('#brush-color-id').simplecolorpicker().on('change', function () {
			var value = $('#brush-color-id').val();
			BRUSH.setColor(value);
			draw_brush_preview()
		});


	}

	//var iphone = navigator.userAgent.match(/iPhone/i)?true:false;
	function initApp() {
        setup_zoom_button();
        setup_undo_button();
		setup_brush_color_picker();

		view = new plx.View('plexo-canvas-id');
		dataset = new plx.Dataset('data/ds_us_1', init_slice, end_slice, step_slice);
		view.load(dataset, load_dataset_callback);
	};

	//var iphone = navigator.userAgent.match(/iPhone/i)?true:false;

      /**
      * Conserve aspect ratio of the orignal region. Useful when shrinking/enlarging
      * images to fit into a certain area.
      *
      * @param {Number} srcWidth Source area width
      * @param {Number} srcHeight Source area height
      * @param {Number} maxWidth Fittable area maximum available width
      * @param {Number} maxHeight Fittable area maximum available height
      * @return {Object} { width, heigth }
      */
    function calculateAspectRatioFit(srcWidth, srcHeight, maxWidth, maxHeight) {

        var ratio = Math.min(maxWidth / srcWidth, maxHeight / srcHeight);

        return { width: Math.floor(srcWidth*ratio), height: Math.floor(srcHeight*ratio) };
     }




    function setViewDimensions(){
        var heightNavBar = $('div.navbar-header').outerHeight();
        var heightFooter = $('.plexo-footer').outerHeight();
        var heightWindow = $(window).height();
        var widthWindow  = $(window).width();
        var hAvailable = heightWindow - (heightNavBar + heightFooter);

        var ratio = calculateAspectRatioFit(view.currentSlice.image.width,
                                            view.currentSlice.image.height,
                                            widthWindow,
                                            hAvailable);
        view.height=ratio.height;
        view.width =ratio.width;
        view.showCurrentSlice();

    };

</script>

</head>

<body class="top-navigation" onload="initApp()">

<div id="wrapper">
	<div id="page-wrapper" class="custom-background-color" style="min-height: 620px;">
		<div class="row">
			<nav class="navbar navbar-fixed-top custom-color-navbar custom-bottom-border" role="navigation">
				<div class="navbar-header">
					<button aria-controls="navbar" aria-expanded="false" data-target="#navbar" data-toggle="collapse" class="navbar-toggle collapsed" type="button">
						<i class="fa fa-reorder"></i>
					</button>
					<a href="#" class="navbar-brand"><img src="img/plexo_inv2.svg" style="height:30px"/></a>
				</div>
				<div class="navbar-collapse collapse" id="navbar">
					<ul class="nav navbar-nav">
						<li>
							<a href="#"><i class="fa fa-database fa-lg"></i><span class="nav-label">Datasets</span></a>
						</li>
						<li>
							<a href="#"><i class="fa fa-cloud-upload fa-lg"></i><span class="nav-label">Send us your data</span> </a>
						</li>
						<li>
							<a href="#"><i class="fa fa-bullhorn fa-lg"></i><span class="nav-label">News</span> </a>
						</li>
						<li>
							<a href="#"><i class="fa fa-gear fa-lg"></i><span class="nav-label">Tour</span> </a>
						</li>
						<li>
							<a href="#"><i class="fa fa-facebook fa-lg"></i><span class="nav-label">Follow us</span> </a>
						</li>
						<li>
							<a href="#"><i class="fa fa-info fa-lg"></i><span class="nav-label">About us</span> </a>
						</li>
					</ul>
					<ul class="nav navbar-top-links navbar-right">
						<li>
							<a href="login.html">
								<i class="fa fa-sign-out"></i> Log out
							</a>
						</li>
					</ul>
				</div>
			</nav>
		</div><!-- header row -->
		<div class="row">


            <div class="col-lg-12 plexo-canvas-container">

                <div id="dataset-progressbar-container-id" class="progress progress-striped active">
                    <div id="dataset-progressbar-id" class="progress-bar progress-bar-info" role="progressbar"
                         aria-valuenow="0" aria-value-min="0" aria-value-max="100" style="width:100%">
                        Loading...
                    </div>
                </div>

                <canvas id="plexo-canvas-id"></canvas>

            </div>

		</div><!-- body row-->

        <div class="row footer fixed plexo-footer">

            <div class="row clearfix">
                <div class="col-lg-8 col-sm-8 col-xs-8">
                <a class="btn btn-white" href="#" data-toggle="modal" data-target="#brush-options-modal"><i class="fa fa-paint-brush"></i></a>
                <a class="btn btn-white" href="#" data-toggle="modal"><i class="fa fa-eraser"></i></a>
                <a id='btn-zoom-id' class="btn btn-white" href="#tab-zoom-options" data-toggle="tab"><i class="fa fa-search"></i></a>
                <span class="inline"></span>
                <a id='btn-undo-id' class="btn btn-white"><i class="fa fa-undo"></i></a>
                <a class="btn btn-white"><i class="fa fa-save"></i></a>
                 </div>
                <div class="col-lg-4 col-sm-4 col-xs-4">
                 <div class="wrapper"><input style="display:none" type="text" id="dataset-slider-id" name="dataset-slider" value=""/>
                     </div>
                </div>
            </div>
        </div><!--footer-->

	</div><!-- page wrapper-->
</div><!--wrapper -->




<div id="brush-options-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h3 class="modal-title">Brush</h3>
			</div><!-- modal header-->
			<div class="modal-body">
				<div class="row">
					<div class="col-xs-12 col-md-12 col-lg-12">
						<h4>Current Label</h4>
						<select id="brush-color-id">
							<option value="#ac725e">#ac725e</option>
							<option value="#d06b64">#d06b64</option>
							<option value="#f83a22">#f83a22</option>
							<option value="#fa573c">#fa573c</option>
							<option value="#ff7537">#ff7537</option>
							<option value="#ffad46">#ffad46</option>
							<option value="#42d692">#42d692</option>
							<option value="#16a765">#16a765</option>
							<option value="#7bd148">#7bd148</option>
							<option value="#b3dc6c">#b3dc6c</option>
							<option value="#fbe983">#fbe983</option>
							<option value="#fad165">#fad165</option>
							<option value="#92e1c0">#92e1c0</option>
							<option value="#9fe1e7">#9fe1e7</option>
							<option value="#9fc6e7">#9fc6e7</option>
							<option value="#4986e7">#4986e7</option>
							<option value="#9a9cff">#9a9cff</option>
							<option value="#b99aff">#b99aff</option>
							<option value="#c2c2c2">#c2c2c2</option>
							<option value="#cabdbf">#cabdbf</option>
							<option value="#cca6ac">#cca6ac</option>
							<option value="#f691b2">#f691b2</option>
							<option value="#cd74e6">#cd74e6</option>
							<option value="#a47ae2">#a47ae2</option>
						</select>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-6 col-md-6 col-lg-6">
						<h4>Size</h4>

						<div><input style="display:none" type="text"
						            id="brush-size-slider-id" name="dataset-slider"
						            value=""/></div>
					</div>

					<div class="col-xs-6 col-md-6 col-lg-6">
						<h4>Opacity</h4>

						<div><input style="display:none" type="text"
						            id="brush-opacity-slider-id"
						            name="dataset-slider"
						            value=""/></div>
					</div>

				</div>
				<div class="row">
					<div class="col-xs-6 col-md-6 col-lg-6">
						<h4>Shape</h4>

						<div class="radio radio-info radio-inline">
							<input id="brush-shape-circle" type="radio"
							       checked="true"
							       value="brush-circle" name="brush-shape"></input>
							<label for="brush-shape-circle">circle</label>
						</div>
						<div class="radio radio-info radio-inline">
							<input id="brush-shape-square" type="radio"
							       value="brush-square" name="brush-shape"></input>
							<label for="brush-shape-square">square</label>
						</div>
					</div>
					<div class="col-xs-6 col-md-6 col-lg-6">
						<h4>Preview</h4>
						<canvas id="brush-canvas-id" width="50px"
						        height="50px"></canvas>
					</div>

				</div>
            </div><!-- modal body -->
            <div class="modal-footer">

					<button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>

			</div><!--modal footer-->
		</div><!-- modal content-->
	</div><!-- modal dialog-->
</div><!-- modal -->

<!--    <div class="ibox">
		<div class="ibox-title"><h5>Spine Phantom 1 <small> Find all the spinous, articular and transverse processes</small></h5> </div>
		<div class="ibox-content">


		</div>
	</div>
</div>

<div class="col-md-4 col-lg-5">
	<div class="tabs-container">
		<ul class="nav nav-tabs">
			<li class="active"><a href="#tab-tools" data-toggle="tab"><i class="fa fa-pencil-square-o"></i>Tools</a></li>
			<li class=""><a href="#tab-labels" data-toggle="tab"><i class="fa fa-list-ol"></i>Labels</a></li>
			<li class=""><a href="#tab-about" data-toggle="tab"><i class="fa fa-info-circle"></i>About this model</a></li>

		</ul>
		<div class="tab-content">
			<div id="tab-tools" class="tab-pane active">
				<div class="panel-body">
					<div class="tabs-container">

							<a class="btn btn-white" href="#tab-brush-options" data-toggle="tab"><i class="fa fa-paint-brush"></i></a>
							<a class="btn btn-white" href="#tab-eraser-options" data-toggle="tab"><i class="fa fa-eraser"></i></a>
							<a id='btn-zoom-id' class="btn btn-white" href="#tab-zoom-options" data-toggle="tab"><i class="fa fa-search"></i></a>
							<span class="inline"></span>
							<a class="btn btn-white"><i class="fa fa-undo"></i></a>
							<a class="btn btn-white"><i class="fa fa-save"></i></a>

						<div class="tab-content">
							<div id="tab-brush-options" class="tab-pane active">



							</div>

							<div id="tab-eraser-options" class="tab-pane">
								<div class="row">Eraser options</div>

							</div>
							<div id="tab-zoom-options" class="tab-pane">
								<div class="row">Zoom options</div>

							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="tab-labels" class="tab-pane">
				<div class="panel-body">test</div>
			</div>
			<div id="tab-about" class="tab-pane">
				<div class="panel-body"></div>
			</div>

		</div>
	</div>
</div>
</div>//-->


<!-- Mainly scripts -->
<script src="js/jquery-2.1.1.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<!-- Custom and plugin javascript -->
<script src="js/inspinia.js"></script>
<script src="js/plugins/pace/pace.min.js"></script>
<script src="js/plugins/jquery-ui/jquery-ui.min.js"></script>
<script src="js/plugins/ionRangeSlider/ion.rangeSlider.min.js"></script>
<script src="js/plugins/simplecolorpicker/jquery.simplecolorpicker.js"></script>

<script>
	$('#brush-options-modal').on('shown.bs.modal', function () {
		setup_brush_sliders();
		setup_brush_type_buttons();
        setup_brush_color_picker();
        draw_checkboard_brush_canvas(6, 6);
        draw_brush_preview();

    })
</script>

</body>
</html>
